<template>
    <div class="step-section">
        <div class="section-header">
            <div class="section-heading">
                <template if:true={isGridView}>
                    <h2>
                        <lightning-icon icon-name={headerIconName} size="small" class="heading-icon"></lightning-icon>
                        {headerTitle}
                    </h2>
                </template>
                <template if:true={isWizardView}>
                    <div class="wizard-heading">
                        <h3>Medications</h3>
                      <!--  <button class="ghost-button wizard-cancel" onclick={cancelWizard}>Cancel</button> -->
                      <!--  <p class="wizard-subcopy">Compact. Step 1: choose. Step 2: enter details. Step 3: review.</p>
                        <div class="wizard-inline-progress">
                            <span class={wizardInlineDotPick}></span>
                            <span class={wizardInlineDotDetails}></span>
                            <span class={wizardInlineDotReview}></span>
                            <span class="wizard-inline-label">Pick → Details → Review</span>
                        </div> -->
                    </div>
                </template>
            </div>
            <template if:true={isWizardView}>
                <button class="ghost-button wizard-cancel" onclick={cancelWizard}>Cancel</button>
            </template>
        </div>

        <template if:true={isGridView}>
            <template if:true={hasMedications}>
                <section class="card grid-controls">
                    <div class="grid-header-row">
                        <div class="control-group">
                            <label class="input-label" for="grid-filter">Filter by</label>
                            <select id="grid-filter" class="text-input" onchange={handleFilterChange}>
                                <template for:each={filterOptionsDecorated} for:item="option">
                                    <option key={option.value} value={option.value} selected={option.selected}>{option.label}</option>
                                </template>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="input-label" for="grid-search">Search</label>
                            <input id="grid-search" class="text-input" type="search" placeholder="Filter by name..." value={searchValue} oninput={handleSearchChange} />
                        </div>
                        <div class="grid-actions">
                        <button class="ghost-button" type="button" onclick={toggleShowNotes}>
                            <template if:true={showAllNotes}>Hide notes</template>
                            <template if:false={showAllNotes}>Show notes</template>
                        </button>
                            <template if:true={showAddButton}>
                                <template if:true={hasMedications}>
                                    <button class="ghost-button" type="button" onclick={handleEditMedicationsWizard}>Edit</button>
                                </template>
                                <button class="primary-button" type="button" onclick={handleAddMedications}>Add Medications</button>
                            </template>
                        </div>
                    </div>
                </section>
            </template>
            <template if:true={hasMedications}>
                <div class="med-grid">
                    <template for:each={filteredMedications} for:item="med">
                        <article key={med.id} class={med.cardClass}>
                            <header class="med-card-header">
                                <div>
                                    <h3>{med.meta.title}</h3>
                                    <p>{med.meta.brand}</p>
                                </div>
                            </header>
                            <template if:true={isRelatedCase}>
                                <p class="med-record">
                                    Medication Id:
                                    <template if:true={med.recordLink}>
                                        <a href={med.recordLink} target="_blank">{med.recordName}</a>
                                    </template>
                                    <template if:false={med.recordLink}>
                                        {med.recordName}
                                    </template>
                                </p>
                            </template>
                            <div class="pill-row">
                                <span class="summary-pill">{med.action}</span>
                                <template if:true={med.frequency}>
                                    <span class="summary-pill">{med.frequency}</span>
                                </template>
                                <template if:true={med.amount}>
                                    <span class="summary-pill">{med.amount} {med.unit}</span>
                                </template>
                                <span class="med-category-pill">{med.meta.category}</span>
                                <template if:true={med.current}>
                                    <span class="summary-pill positive">Current</span>
                                </template>
                                <template if:true={med.allergy}>
                                    <span class="summary-pill warning">Allergy</span>
                                </template>
                            </div>
                            <template if:true={showAllNotes}>
                                <div class="field field-full">
                                    <label class="input-label">Notes</label>
                                    <textarea class="textarea" data-id={med.id} data-field="notes" oninput={handleCardNoteChange} disabled={readOnlyNotes}>{med.notes}</textarea>
                                </div>
                            </template>
                            <template if:false={showAllNotes}>
                                <p class="med-notes">
                                    <template if:true={med.notes}>
                                        {med.previewNotes}
                                    </template>
                                    <template if:false={med.notes}>
                                        —
                                    </template>
                                </p>
                            </template>
                            <div class="card-actions">
                                <template if:true={showNavigation}>
                                    <button class="pill-button" data-id={med.id} onclick={handleEditMedication}>Edit</button>
                                </template>
                                <button class="pill-button danger" data-id={med.id} onclick={handleRemoveMedication}>Remove</button>
                            </div>
                            <template if:true={med.showConfirm}>
                                <div class="remove-confirm">
                                    <p>Remove this medication?</p>
                                    <div class="remove-actions">
                                        <button class="pill-button danger" data-id={med.id} onclick={confirmRemove}>Confirm Remove</button>
                                        <button class="pill-button secondary" onclick={cancelRemove}>Cancel</button>
                                    </div>
                                </div>
                            </template>
                        </article>
                    </template>
                </div>
            </template>
            <template if:false={hasMedications}>
                <section class="card empty-state-card">
                    <div>
                        <p class="empty-title">No medications captured yet</p>
                        <p class="empty-subtitle">Use the button to add items manually.</p>
                    </div>
                    <button class="primary-button" onclick={handleAddMedications}>Add Medications</button>
                </section>
            </template>
        </template>

        <template if:true={isWizardView}>
            <section class="card wizard-shell">
               <!-- <div class="wizard-progress">
                    <span class={wizardStep >= 0 ? 'dot active' : 'dot'}></span>
                    <span class={wizardStep >= 1 ? 'dot active' : 'dot'}></span>
                    <span class={wizardStep >= 2 ? 'dot active' : 'dot'}></span>
                    <span class="wizard-label">{wizardStepLabel}</span>
                </div> -->

                <template if:true={wizardStepIsPick}>
                    <div class="wizard-controls">
                        <div class="control-group">
                            <label class="input-label" for="wizard-filter">Filter by</label>
                            <select id="wizard-filter" class="text-input" onchange={handleWizardFilterChange}>
                                <template for:each={wizardFilterOptions} for:item="option">
                                    <option key={option.value} value={option.value} selected={option.selected}>{option.label}</option>
                                </template>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="input-label" for="wizard-search">Search</label>
                            <input id="wizard-search" class="text-input" type="search" placeholder="Filter by name..." value={wizardSearch} oninput={handleWizardSearchChange} />
                        </div>
                    </div>
                    <div class="wizard-result-row">
                        <span class="result-pill">{wizardResultCount} result(s)</span>
                        <div class="result-actions">
                            <button class="ghost-button" onclick={handleSelectAllFiltered}>Select all (filtered)</button>
                            <button class="ghost-button" onclick={handleClearSelection}>Clear</button>
                        </div>
                    </div>
                    <div class="wizard-catalog">
                        <template for:each={wizardCatalogItems} for:item="item">
                            <label key={item.id} class={item.className}>
                                <input
                                    type="checkbox"
                                    data-id={item.id}
                                    checked={item.checked}
                                    disabled={item.disabled}
                                    onchange={handleWizardSelectionToggle}
                                />
                                <div class="catalog-details">
                                    <p class="catalog-title">{item.title}</p>
                                    <p class="catalog-brand">Brand: {item.brand}</p>
                                    <p class="catalog-description">{item.description}</p>
                                    <span class="category-pill">{item.category}</span>
                                </div>
                            </label>
                        </template>
                    </div>
                </template>

                <template if:true={wizardStepIsDetails}>
                    <template for:each={wizardDraft} for:item="item">
                        <section key={item.id} class="detail-card">
                            <header class="detail-header">
                                <div>
                                    <h3>{item.meta.title}</h3>
                                    <p class="detail-brand">Brand: {item.meta.brand}</p>
                                    <span class="category-pill">{item.meta.category}</span>
                                </div>
                                <button class="text-button" data-id={item.id} onclick={handleWizardRemoveDraft}>Remove</button>
                            </header>
                            <div class="detail-grid">
                                <label class="input-label">Action<span class="required">*</span>
                                    <select class={item.actionClass} data-id={item.id} data-field="action" onchange={handleWizardDetailChange}>
                                        <option value="">Select action</option>
                                        <template for:each={item.actionOptionsDecorated} for:item="option">
                                            <option key={option.value} value={option.value} selected={option.selected}>{option.label}</option>
                                        </template>
                                    </select>
                                    <template if:true={item.actionError}>
                                        <p class="error-inline">Select the Action</p>
                                    </template>
                                </label>
                                <label class="input-label">Frequency
                                    <select class="text-input" data-id={item.id} data-field="frequency" onchange={handleWizardDetailChange}>
                                        <option value="">--</option>
                                        <template for:each={item.frequencyOptionsDecorated} for:item="option">
                                            <option key={option.value} value={option.value} selected={option.selected}>{option.label}</option>
                                        </template>
                                    </select>
                                </label>
                                <label class="input-label">Amount
                                    <input type="number" class="text-input" data-id={item.id} data-field="amount" value={item.amount} oninput={handleWizardDetailChange} />
                                </label>
                                <label class="input-label">Dosing Unit
                                    <select class="text-input" data-id={item.id} data-field="unit" onchange={handleWizardDetailChange}>
                                        <option value="">--</option>
                                        <template for:each={item.unitOptionsDecorated} for:item="option">
                                            <option key={option.value} value={option.value} selected={option.selected}>{option.label}</option>
                                        </template>
                                    </select>
                                </label>
                                <label class="checkbox-field success">
                                    <input type="checkbox" data-id={item.id} data-field="current" checked={item.current} onchange={handleWizardDetailChange} />
                                    <span>Current medication?</span>
                                </label>
                                <label class="checkbox-field alert">
                                    <input type="checkbox" data-id={item.id} data-field="allergy" checked={item.allergy} onchange={handleWizardDetailChange} />
                                    <span>Allergy to this medication?</span>
                                </label>
                            </div>
                            <div class="field field-full">
                                <label class="input-label">Notes</label>
                                <textarea class="textarea" data-id={item.id} data-field="notes" oninput={handleWizardDetailChange}>{item.notes}</textarea>
                            </div>
                        </section>
                    </template>
                </template>

                <template if:true={wizardStepIsReview}>
                    <div class="review-panel">
                        <h3>Review</h3>
                        <div class="review-list">
                            <template for:each={wizardDraft} for:item="item">
                                <article key={item.id} class="review-entry">
                                    <div class="review-heading">
                                        <div>
                                            <h4>{item.meta.title}</h4>
                                            <p class="review-subtitle">{item.meta.brand} · {item.meta.category}</p>
                                        </div>
                                    </div>
                                    <p class="review-line">
                                        Action:
                                        <template if:true={item.action}>
                                            {item.action}
                                        </template>
                                        <template if:false={item.action}>
                                            --
                                        </template>
                                        <template if:true={item.frequency}> | Freq: {item.frequency}</template>
                                        <template if:true={item.amount}> | Amount: {item.amount} {item.unit}</template>
                                    </p>
                                    <template if:true={item.current}>
                                        <p class="review-flag success">Marked as current medication</p>
                                    </template>
                                    <template if:true={item.allergy}>
                                        <p class="review-flag alert">Allergy flagged</p>
                                    </template>
                                    <p class="review-notes">
                                        <span>Notes:</span>
                                        <span>
                                            <template if:true={item.notes}>
                                                {item.notes}
                                            </template>
                                            <template if:false={item.notes}>
                                                —
                                            </template>
                                        </span>
                                    </p>
                                </article>
                            </template>
                        </div>
                    </div>
                </template>

                <div class="wizard-footer">
                    <!--<button class="ghost-button" onclick={wizardBack} disabled={wizardBackDisabled}>Back</button> -->
                    <div class="wizard-actions">
                        <template if:true={wizardStepIsReview}>
                            <button class="ghost-button" onclick={handleReviewEditDetails}>Edit Details</button>
                            <button class="ghost-button" onclick={handleReviewChangeSelection}>Change Selection</button>
                        </template>
                        <template if:false={wizardStepIsReview}>
                            <button class="ghost-button wizard-cancel" onclick={cancelWizard}>Cancel</button>
                        </template>
                        <button class="primary-button" onclick={wizardNext} disabled={wizardNextDisabled}>
                            <template if:true={wizardStepIsReview}>Save</template>
                            <template if:false={wizardStepIsReview}>Next</template>
                        </button>
                    </div>
                </div>
            </section>
        </template>

        <template if:true={showNavigation}>
            <div class="slds-grid slds-grid_align-spread slds-var-m-top_large">
                <button class="slds-button btn-back" type="button" onclick={handleBack}>Back</button>
                <button class="slds-button btn-next" type="button" onclick={handleNext}>Next</button>
            </div>
        </template>
    </div>
</template>